import os
from cellpose import models, io

def train_cellpose(img_src, mask_src, model_name='toxopv', model_type='cyto', nchan=2, channels=[0, 0], learning_rate=0.2, weight_decay=1e-05, batch_size=8, n_epochs=500):
    model_name=model_name+'.CP_model'
    # Load training data
    train_images, train_masks, _, _, _, _ = io.load_train_test_data(img_src, mask_src, mask_filter='')

    # Create a CellposeModel instance
    model = models.CellposeModel(gpu=True, 
                                 model_type=model_type, 
                                 net_avg=True, 
                                 diam_mean=30.0, 
                                 residual_on=True, 
                                 style_on=True, 
                                 concatenation=False, 
                                 nchan=nchan)

    # Specify the save path for the model
    model_save_path = os.path.join(mask_src, 'models', 'cellpose_model')
    os.makedirs(os.path.dirname(model_save_path), exist_ok=True)

    # Train the model
    model.train(train_data=train_images,
                train_labels=train_masks,
                channels=channels,  # Adjust based on your image channels
                learning_rate=learning_rate,
                weight_decay=weight_decay,
                batch_size=batch_size,
                n_epochs=n_epochs,
                save_path=model_save_path,
                model_name=model_name)

    return print(f"Model saved at: {model_save_path}")

